<?php
if (!defined('MALWARECHECK_VERSION')) die('No access');

require_once('./app/app.php');
require_once('./app/logger.php');
require_once('./app/logLevel.php');
require_once('./app/scanner.php');
require_once('./app/wordpress/checker.php');

define('WORDPRESS_CHECKER', 'true');

$app = App::init();

$config = array();
$config['date.timezone'] = 'Europe/Amsterdam';
$config['locale'] = 'en_US.utf-8';
$config['max_execution_time'] = '0';
$config['set_time_limit'] = '0';
$config['display_errors'] = '0';


/* Config date.timezone */
$app->log('Current date.timezone: '.date_default_timezone_get(),LogLevel::DEBUG);
$app->log('Force setting date.timezone: '.$config['date.timezone'],LogLevel::DEBUG);
date_default_timezone_set($config['date.timezone']);

/* Config locale */
$app->log('Force setting locale: '.$config['locale'],LogLevel::DEBUG);
setlocale(LC_ALL, $config['locale']);

/* Config max_execution_time */
$app->log('Current max_execution_time: '.ini_get('max_execution_time'),LogLevel::DEBUG);
$app->log('Force setting max_execution_time: '.$config['max_execution_time'],LogLevel::DEBUG);
ini_set('max_execution_time', $config['max_execution_time']);

/* Config set_time_limit */
$app->log('Current set_time_limit: '.ini_get('set_time_limit'),LogLevel::DEBUG);
$app->log('Force setting set_time_limit: '.$config['set_time_limit'],LogLevel::DEBUG);
ini_set('set_time_limit', $config['set_time_limit']);

/* Config display_errors */
$app->log('Current display_errors: '.ini_get('display_errors'),LogLevel::DEBUG);
$app->log('Force setting display_errors: '.$config['display_errors'],LogLevel::DEBUG);
ini_set('display_errors', $config['display_errors']);


$scanner = $app->getScanner();

$scanner->addFileToCheck("c99.php", "R57 Shell", "This file is part of the backdoor R57 and used to control a webserver.");
$scanner->addFileToCheck("ofc_upload_image.php", "OpenFlashCard Demo", "Probably an OpenFlashChart library demo file that has known input validation error (CVE-2009-4140).");
$scanner->addFileToCheck("phpinfo.php", "PHP Information file", "This file commonly contains the phpinfo() function to reveal lots of server information.");
$scanner->addFileToCheck("r57.php", "R57 Shell", "This file is part of the backdoor R57 and used to control a webserver.");
$scanner->addFileToCheck("social.png", "Possible CryptoPHP", "This file is part of the CryptoPHP backdoor.");

$scanner->addDirectoryToIgnore(".", "Special current directory");
$scanner->addDirectoryToIgnore("..", "Special parent directory");
$scanner->addDirectoryToIgnore("_sohocheck", "Working directory of Soho Check");

/* PHP Functions */
$scanner->addPatternToCheck("base64_decode\(.*?\)","Decodes data encoded with MIME base64", "info");
$scanner->addPatternToCheck("base64_encode\(.*?\)", "Encodes data with MIME base64", "info");
$scanner->addPatternToCheck("eval\(.*?\)", "Evaluate a string as PHP code", "info");
$scanner->addPatternToCheck("exec\(.*?\)", "Execute an external program", "info");
$scanner->addPatternToCheck("gzdecode\(.*?\)", "Decodes a gzip compressed string", "info");
$scanner->addPatternToCheck("gzdeflate\(.*?\)", "Deflate a string", "info");
$scanner->addPatternToCheck("gzuncompress\(.*?\)", "Uncompress a compressed string", "info");
$scanner->addPatternToCheck("passthru\(.*?\)", "Execute an external program and display raw output", "info");
$scanner->addPatternToCheck("popen\(.*?\)", "Open process file pointer", "info");
$scanner->addPatternToCheck("proc_nice\(.*?\)", "Change the priority of the current process", "info");
$scanner->addPatternToCheck("proc_open\(.*?\)", "Execute a command and open file pointers", "info");
$scanner->addPatternToCheck("shell_exec\(.*?\)", "Execute command via shell and return output", "info");
$scanner->addPatternToCheck("system\(.*?\)", "Execute an external program and display the output", "info");

/* SMTP */
$scanner->addPatternToCheck('fsockopen\s*\(.*,\s*[ \'\"](?:25|587|465|475|2525)[ \'\"]', "Opening sockets to known SMTP ports", "The script is opening a socket to one of the known SMTP ports. Commonly used to send spam runs.");

$app->setScanner($scanner);
?>
