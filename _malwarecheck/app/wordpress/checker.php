<?php
if (!defined('MALWARECHECK_VERSION')) die('No access');

class WordpressChecker {
	private $logger;

	public $path = '../';

	public static function init() {
		return new WordpressChecker();
	}

	public function __construct() {
		$this->logger = Logger::instance();
	}

	public function isValidHash($path, $filename) {
		if (isset($this->checksums[$filename])) {
			if ($this->checksums[$filename] !== md5_file($path)) {
				return false;
			}
		}
		return true;
	}

	public function parseWordpressVersion() {
		$this->logger->log('Parse Wordpress version');
		include ($this->path.'wp-includes/version.php');
		$this->logger->log('Wordpress version '.$wp_version);

		$this->logger->log('Contact Wordpress API for file checksums');
		$wordpressApi = 'http://api.wordpress.org/core/checksums/1.0/?version=' . $wp_version . '&locale=en_US';
		$apiResponse = file_get_contents($wordpressApi);
		$wordpressChecksums = json_decode($apiResponse);
	
		$this->checksums = (array)$wordpressChecksums->checksums;
		$this->logger->log('Retrieved checksums for '.count($this->checksums).' files');
	}

	public function run() {
		$this->parseWordpressVersion();
	}
}
